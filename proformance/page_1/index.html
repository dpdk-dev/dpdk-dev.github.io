<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Linux系统性能评测基准系统配置及其原理 - 社区讨论存档</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">介绍</a></li><li class="chapter-item expanded "><a href="../../proformance/index.html"><strong aria-hidden="true">1.</strong> 性能·测试</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../proformance/page_1/index.html" class="active"><strong aria-hidden="true">1.1.</strong> Linux系统性能评测基准系统配置及其原理</a></li></ol></li><li class="chapter-item expanded "><a href="../../compile/index.html"><strong aria-hidden="true">2.</strong> 编译·链接</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../compile/page_1/index.html"><strong aria-hidden="true">2.1.</strong> attribute((constructor))与静态链接</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">社区讨论存档</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/dpdk-dev/dpdk-dev.github.io.src" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="linux系统性能评测基准系统配置及其原理"><a class="header" href="#linux系统性能评测基准系统配置及其原理">Linux系统性能评测基准系统配置及其原理</a></h1>
<p>全文转载，文章来源：<a href="https://mp.weixin.qq.com/s/nkiE4CEo_zSN35I_qITAvQ">https://mp.weixin.qq.com/s/nkiE4CEo_zSN35I_qITAvQ</a></p>
<h2 id="概要"><a class="header" href="#概要">概要</a></h2>
<p>开发人员在高性能系统的性能调优过程中，经常会碰到各种背景的噪声干扰，从而使得收集的数据不够精确。本文主要从CPU以及Linux操作系统的角度来分析各种噪声的来源以及消除方法。最终的目标是搭建基准平台，在特定的cpu上实现”0”干扰。</p>
<h2 id="cpu-运行中存在的几种背景噪声干扰来源"><a class="header" href="#cpu-运行中存在的几种背景噪声干扰来源">Cpu 运行中存在的几种背景噪声干扰来源</a></h2>
<h3 id="1-调度器"><a class="header" href="#1-调度器">1. 调度器：</a></h3>
<p>进程调度器对于系统的影响几乎无处不在，Linux内核一般来说是使用公平的分时调度策略（CFS）。需要特定的参数来调整调度器的行为，从而尽量减少对于测量进程的干扰。</p>
<h3 id="2-中断"><a class="header" href="#2-中断">2. 中断：</a></h3>
<p>中断是系统必须要响应的事件，具有较高优先级，可以抢占普通的用户进程。</p>
<ul>
<li>
<p>a. 硬件中断</p>
<p>主要来自外部事件，CPU需要非常及时的响应。比如最常见的IO，时钟，Linux内核支持的硬件中断数量众多，需要注意亲和性配置。可以取消响应一些比较特殊的中断。</p>
</li>
<li>
<p>b. 软中断Softirq</p>
<p>软中断是硬件中断处理的衍生子系统。Linux硬件中断响应只需要处理一些必须立即响应的操作，而将一些可以延后处理的操作移交给软中断。Linux中的有10类软中断，后续我们将会分析。</p>
</li>
<li>
<p>c. Workqueue</p>
<p>Workqueue也是Linux中常见的一类延迟操作的任务类型</p>
</li>
</ul>
<h3 id="3-电源管理"><a class="header" href="#3-电源管理">3. 电源管理：</a></h3>
<p>现代处理器通常为了更高效的利用能源，都会支持一些高级电源管理的功能。这些电源管理的功能如果使用不当也会对于性能评测造成影响。</p>
<h3 id="4-时间源"><a class="header" href="#4-时间源">4. 时间源：</a></h3>
<p>如果要进行性能评测，就离不开时间戳。所以时间戳的正确采集方法也是至关重要的。</p>
<p>以上这几种因素往往是互相交织的，比如进程调度器需要时钟中断来驱动，电源管理子系统需要调度器来驱动。时间戳的采集和微架构也是息息相关的。下面我们将通过案例逐一分析。</p>
<h2 id="系统配置案例"><a class="header" href="#系统配置案例">系统配置案例</a></h2>
<ul>
<li>
<p>系统配置信息：</p>
<pre><code>CPU: Intel 9900KF   P1 Frequency 3.6Ghz   1-core Turbo  5.0Ghz   HT-disabled
RAM: 16GB DDR4-3200
Ubuntu 19.04:  Kernel  5.0.0-38-generic  X86_64
Boot Parameter:
BOOT_IMAGE=/boot/vmlinuz-5.0.0-38-generic
root=UUID=697aea9f-2de2-4b9c-921d-5bd5f963c91f ro ipv6.disable=1
isolcpus=7 nohz_full=7 mce=off tsc=reliable no_watchdog  irqaffinity=0 hpet=disable
quiet splash vt.handoff=1
</code></pre>
</li>
<li>
<p>基准系统配置目标：</p>
<p>在baremetal机器上(vt-x环境下配置会更加复杂难以精确控制）， 将Core 7隔离在调度器之外， 最大程度的减少各种因素对于Core 7的干扰。</p>
</li>
<li>
<p>启动参数详解：</p>
<ul>
<li>
<p>isolcpus = managed_irq cpuslist</p>
<p>Isolcpus 主要是将目标cpu从调度器的调度算法中隔离出来。也就是说从用户进程的角度来说，调度器不会主动调度任何进程到目标cpu上来。但是仅仅靠这个参数仍然不能保证所有软/硬中断和一些其他的内核组件不会运行在目标的cpu上。</p>
</li>
<li>
<p>nohzfull = cpulist</p>
<p>这个参数还有一个相对弱化的版本nohz。nohz的含义是在目标cpu的runqueue上没有任何可调度实体时，cpu进入idle状态，在此情况下该cpu停止时钟tick（缺省是10ms一次）。那么nohzfull就更进一步，在runqueue上只有一个活动的实体的时候也会停止时钟tick。这样就会大大减少对正在运行的唯一的进程的干扰（不是100%消除）。值得注意的是在非服务器版本的内核中nohzfull一般是没有打开的，需要重新编译内核。大家可以检查对应的内核编译选项CONFIGNOHZFULL=y。如果没有打开则会在启动日志中显示警告。同时nohzfull也就隐含了rcunocbs=cpulist。</p>
<p>下图是成功打开选项的日志。</p>
<p><img src="4d5b868ee68787c14de1bd6dc67cdb26.jpg" alt="" /></p>
<p>下图是没有打开编译选项的报错信息。</p>
<p><img src="eff917667816141bd5bf660804219ef1.jpg" alt="" /></p>
<p>在内核的Timer System 中修改选项。</p>
<p><img src="c1f76363680fdd5cc7d39c8006df9e1a.jpg" alt="" /></p>
</li>
<li>
<p>nowatchdog</p>
<p>关闭所有的软/硬件死锁监测。</p>
</li>
<li>
<p>hpet=disable, tsc=reliable</p>
<p>这部分主要是针对时间子系统。hpet=disable 主要是避免hpet产生过多的中断干扰系统。tsc=reliable 标记tsc为可靠的，减少运行时，时间源校验。在我们的验证过程中，这个参数对于减少jitter有较大帮助。</p>
</li>
</ul>
</li>
</ul>
<h2 id="软硬中断的隔离"><a class="header" href="#软硬中断的隔离">软硬中断的隔离</a></h2>
<ul>
<li>
<p>Disable irqblance service</p>
<p>我们并不希望任何硬件中断被发送到Core 7上</p>
<p>所以我们需要disable  irqblance service</p>
</li>
<li>
<p>Take care irq affinity</p>
<p>硬件中断的亲和性也需要注意。</p>
<p>同样是避免任何硬件中断被发送到Core 7</p>
</li>
<li>
<p>修改</p>
<p>/sys/devices/virtual/workqueue/cpumask to 1</p>
<p>效果对比截图</p>
<p>下图是/proc/interrupts</p>
<p><img src="76d4bf04b1862db8c374a95de8c35ba5.jpg" alt="" /></p>
<p>下图是 /proc/softirqs</p>
<p><img src="99c6fbe13d48b42ac34d7e8cd4a1b51d.jpg" alt="" /></p>
<p>下图是htop显示的信息， 可以观察到core 7上的可调度实体已经压缩到了最少</p>
<p><img src="7c2a55221734c7c5d51b952eade582d1.jpg" alt="" /></p>
</li>
</ul>
<h2 id="msr"><a class="header" href="#msr">MSR</a></h2>
<p>MSR(ModelSpecific Register) 是配置处理器和获取处理器状态信息的关键接口。 MSR主要分为两类。 </p>
<ul>
<li>
<p>Per-Core MSR</p>
<p>这类的MSR 的读写指令都必须本地的Core执行，所以要尽量避免从其它的Core上来读写。例如 从Core 7上读写Core 3。</p>
<p>这样Linux kernel还需要调度这个读写操作到目标Core 3上来 会带来不必要的延迟。</p>
<p>同时 如果在用户层（ring3）中试图读写msr也需要切换到kernel来完成这个操作(通过IPI，CAL 中断）。也会对应用有干扰。</p>
<p>对于性能评测来说最典型的就是APERF/MPERF，以及HWP对应的MSR，以及PMU的配置接口MSR都是Per-Core。访问Per-MSR的延迟无法完全避免，所以要注意采样的频率，防止过度采样。</p>
</li>
<li>
<p>Un-Core MSR</p>
<p>这类MSR并不属于任何具体的Core，是公共资源。最典型的就是UNCORE_RATIO_LIMIT MSR。Un-Core MSR可以从任一Core发起读写。只要避免从正在评测的Core发起读写即可.</p>
<p>通常来讲，MSR需要通过 加载内核模块msr（/dev/msr), 之后通过rdmsr/wrmsr工具来操作。</p>
</li>
</ul>
<h2 id="电源管理"><a class="header" href="#电源管理">电源管理</a></h2>
<p>Linux kernel中的电源管理主要由以下的两个子系统来完成。在kernel 4.10以后，电源管理系统是由调度器来触发。</p>
<ul>
<li>
<p>CPU freq</p>
<p>CPU freq 子系统主要管理在C0状态下 处理器频率的调整，主要由两部分组成：</p>
<ol>
<li>
<p>CPU freq driver</p>
<p>主要是针对各种不同硬件适配的对应的调频驱动程序。</p>
</li>
<li>
<p>CPU freq governor</p>
<p>主要是各种不同的调频策略。</p>
</li>
</ol>
<p>X86环境下主要有两种选择</p>
<ol>
<li>
<p>acpi_cpufreq driver以及其对应的7种governor</p>
<p>见参考链接：
<a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html">https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html</a></p>
</li>
<li>
<p>intel_pstate driver及其对应的2种governor（这是系统缺省的配置）</p>
<p>intel_pstate driver是比较特别的驱动，相比于其它平台。intel_pstate driver主要是利用x86的HWP硬件特性来调整频率。提供了有限的可定制策略。自动化程度更好，overhead更少。</p>
</li>
</ol>
<p>sysfs entries</p>
<ul>
<li>见参考链接：
<a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html">https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html</a></li>
</ul>
</li>
<li>
<p>CPU idle</p>
<p>CPU idle子系统主要管理在C1-C7状态下处理器idle状态调整，主要由两部分组成：</p>
<ol>
<li>
<p>CPU idle driver</p>
<p>主要是针对各种不同硬件适配的对应的idle驱动程序</p>
</li>
<li>
<p>CPU idle governor</p>
<p>主要是各种不同的idle时长策略</p>
</li>
</ol>
<p>X86环境下主要有两种选择</p>
<ol>
<li>
<p>acpi_idle driver</p>
<p>缺省是menu governor</p>
</li>
<li>
<p>intel_idle driver</p>
<p>缺省是menu governor（这是系统缺省的配置, ladder需要重新编译内核）</p>
</li>
</ol>
<p>sysfs entries</p>
<ul>
<li>
<p>见参考链接：</p>
<p><a href="https://www.kernel.org/doc/html/latest/admin-guide/pm/cpuidle.html">https://www.kernel.org/doc/html/latest/admin-guide/pm/cpuidle.html</a></p>
</li>
</ul>
</li>
</ul>
<p>推荐的配置方法：</p>
<ol>
<li>
<p>在BIOS中，Disable Turbo</p>
</li>
<li>
<p>应用power.py[2]脚本锁定目标Core的频率（或者在BIOS 中disable Pstate）</p>
</li>
<li>
<p>设定内核参数intel_idle.max_cstate=1. </p>
<p>如果需要彻底禁止idle 推荐 processor.max_cstate=0，idle=poll<br />
这里需要注意 intel_idle.max_cstate=0只是disable intel_idle driver转而使用acpi_idle driver
根据workload特点调整UNCORE_RATIO_LIMIT的min/max ratio </p>
</li>
</ol>
<h2 id="ipitlb-shootdown优化"><a class="header" href="#ipitlb-shootdown优化">IPI，TLB Shootdown优化</a></h2>
<p>进程隔离会减少shootdown，但是内核部分做不到隔离地址空间。仍然会导致一定数量的tlb shootdown。禁用 VT-X 减少 IPI。
MSR不要过采样！因为per core的MSR读写操作从非本地core调用，Linux是通过IPI调度到目标core上执行。</p>
<p>除此之外, 调度算法/NUMA Aware/L3Cache QoS(RDT)/SMM-BMC/SmartEngine等模块都会对系统性能测试有着噪音干扰，敬请期待后续内容~</p>
<h2 id="reference"><a class="header" href="#reference">Reference</a></h2>
<ol>
<li>
<p>Intel SDM</p>
</li>
<li>
<p>Power.py</p>
<p><a href="https://github.com/intel/CommsPowerManagement">https://github.com/intel/CommsPowerManagement</a></p>
</li>
<li>
<p><a href="https://www.kernel.org/doc/Documentation/kernel-per-CPU-kthreads.txt">https://www.kernel.org/doc/Documentation/kernel-per-CPU-kthreads.txt</a></p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../proformance/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../compile/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../proformance/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../compile/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        
        <script src="../../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
